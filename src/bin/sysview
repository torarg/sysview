#!/bin/sh

usage="usage: sysview [-huV] [-d DAYS] HTML_ROOT"
cache_dir="$HOME/.cache/sysview"
config_dir="/usr/local/share/sysview"

VERSION=0.2.0

html_head() {
    echo "$(cat <<EOF
<!DOCTYPE html>
<html>
    <head>
        <title>sysview: $1</title>
        <link rel="stylesheet" href="style.css">
        <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/svg+xml" href="favicon.svg" />
        <link rel="shortcut icon" href="favicon.ico" />
        <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
        <link rel="manifest" href="site.webmanifest" />
        <meta name="apple-mobile-web-app-title" content="sysview" />
        <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0">
        <meta http-equiv="refresh" content="60">
    </head>
    <body>
    <header>
        <div><a class="header_link" href=index.html>sysview</a></div>
        <div>:</div>
        <div>$1</div>
    </header>
    <main>
    <section class="tiles-container">
EOF
)"
}

html_foot() {
    echo "$(cat <<EOF
    </section>
    </main>
    <footer>
    <div>
        <pre id="legend" class="item_ok">OK</pre>
        <pre id="legend" class="item_warning">Warning</pre>
        <pre id="legend" class="item_critical">Critical</pre>
        <pre id="legend" class="item_unknown">Unknown</pre>
        <pre id="legend" class="item_outdated">Outdated</pre>
    </div>
    </body>
</html>
EOF
)"
}

update_outdated() {
    find ${cache_dir}/ -name "*.html" -mtime +${outdated_after} -exec sed -i 's/pre class="item_.*$/pre class="item_outdated">/g' {} \;
    find ${cache_dir}/ -name "*.html.detail.part.*" -mtime +${outdated_after} -exec sed -i 's/pre class="item_.*$/pre class="item_outdated">/g' {} \;
    find ${cache_dir}/ -name "*.html.overview.part" -mtime +${outdated_after} -exec sed -i 's/div class="tile_.*$/div class="tile_outdated">/g' {} \;
}


parse_report_items() {
    item_count=0
    item_pointer=0
    while read line; do
        if echo "$line" |egrep -q '^OK:|^CRITICAL:|^WARNING:|^UNKNOWN:'; then
            item_status="$(echo $line | cut -f 1 -d ':' |  tr '[:upper:]' '[:lower:]')"
            items="${items}$(echo "Last seen: $date")\n"
        fi
        if [ "$line" == "---" ] && [ "$item_count" -eq "0" ]; then
            item_count=1
            item_pointer=1
            items="${items}<pre class=\"CSS_CLASS\">\n"
        elif [ "$line" == "---" ] && [ "$item_count" -gt "0" ]; then
            items="${items}</pre>"
            item_count="$((item_count + 1 ))"
            items="$(echo "$items" | sed "s/CSS_CLASS/item_$item_status/g")"
            item_status=""
        elif [ "$item_count" -gt "0" ] && [ "$item_pointer" -ne "$item_count" ]; then
            items="${items}<pre class=\"CSS_CLASS\">\n${line}\n"
            item_pointer="$((item_pointer + 1 ))"
        elif [ "$item_count" -gt "0" ]; then
            items="${items}${line}\n"
        fi
    done
    if [ -n "$items" ]; then
        items="$(echo "$items" | sed '$ d')"
        items="$items\n</pre>"
    fi
    items="$(echo "$items" | sed "s/CSS_CLASS/item_$item_status/g")"
    echo "$items"
}


parse_report() {
    report_started=0
    report=""

    while read line; do
        if [[ "$line" == "Hostname: "* ]] ; then
            report_started=1
            hostname=$(echo "$line" | awk '{ print $2 }')
            report="${report}${line}\n"
        elif [[ "$line" == "Date: "* ]] && [ "$report_started" -eq "1" ]; then
            date=$(echo "$line" | cut -f 2- -d " ")
            report="${report}${line}\n"
        elif [[ "$line" == "Type: "* ]] && [ "$report_started" -eq "1" ]; then
            type=$(echo "$line" | cut -f 2- -d " ")
            report="${report}${line}\n"
        elif [ "$report_started" -eq "1" ]; then
            report="${report}${line}\n"
        fi
    done

    if [ -z "$hostname" ] || [ -z "$date" ] || [ -z "$report" ]; then
        echo "failed parsing report"
        exit 0
    fi

    [ -z "$type" ] && type="sysreport" # fallback for now, since this is a new field
    #echo "$report"
}

get_worst_status() {
    text="$report"
    if stat -q ${cache_dir}/${hostname}.html.detail.part.* > /dev/null; then
        #find ${cache_dir}/${hostname}.html.detail.part.* -mtime -1 -exec sed -i 's/pre class="item_outdated.*$/pre class="item_ok">/g' {} \;
        for file in  ${cache_dir}/${hostname}.html.detail.part.*; do
            if [[ "$file" == *".part.${type}"* ]]; then
                continue
            fi
            text="${text}\n$(cat ${file})"
        done
    fi

    if echo "$text" | egrep -q '<pre class="item_outdated">'; then
        worst_status="outdated"
    elif echo "$text" | grep -q "CRITICAL: "; then
        worst_status="crit"
    elif echo "$text" | grep -q "WARNING: "; then
        worst_status="warn"
    elif echo "$text" | grep -q "OK: "; then
        worst_status="ok"
    else
        worst_status="unknown"
    fi
}

process_report() {
    worst_status="unknown"
    parse_report
    report_items="$(echo "$report" | parse_report_items)"
    get_worst_status
    overview_part="${cache_dir}/${hostname}.html.overview.part"
    detail_view_part="${cache_dir}/${hostname}.html.detail.part.${type}"
    [ -f "$overview_part" ] && rm $overview_part
    [ -f "$detail_view_part" ] && rm $detail_view_part

    cat > ${overview_part} <<EOF
<a href="$hostname.html">
    <div class="tile_$worst_status">
        <h4>$hostname</h5>
        <p>$date</p>
    </div>
</a>
EOF

    echo "$report_items" >> $detail_view_part

}

update_index_cache() {
    tmp_index_file="${cache_dir}/index.html"

    # render overview
    html_head "index" > $tmp_index_file
    for file in ${cache_dir}/*.overview.part; do
        if grep -q tile_crit $file; then
            cat $file >> $tmp_index_file
        fi
    done
    for file in ${cache_dir}/*.overview.part; do
        if egrep -q 'tile_outdated|tile_warn' $file; then
            cat $file >> $tmp_index_file
        fi
    done
    for file in ${cache_dir}/*.overview.part; do
        if grep -q tile_ok $file; then
            cat $file >> $tmp_index_file
        fi
    done
    html_foot >> $tmp_index_file
}

update_host_cache() {
    tmp_detail_file="${cache_dir}/${hostname}.html"
    # render detail views
    html_head "$hostname" > $tmp_detail_file
    for file in ${cache_dir}/${hostname}.html.detail.part.*; do
        cat $file >> $tmp_detail_file
    done
    html_foot >> $tmp_detail_file
}


outdated_after=1
read_report="yes"
while getopts :huVd: flag; do
    case "${flag}" in
        h) echo "$usage" && exit 0 ;;
        u) read_report="no" ;;
        V) echo "$VERSION" && exit 0 ;;
        d) outdated_after="$OPTARG" ;;
        ?) echo "error: invalid args\n$usage" >&2 && exit 1 ;;
    esac
done
shift $(($OPTIND - 1))

html_root="${1%/}"
html_root_name="$(realpath $html_root | sed 's|/|_|g')"
cache_dir="${cache_dir}/${html_root_name}"

[ -z "$html_root" ] && echo "error: no html root\n$usage" >&2 && exit 1
[ ! -d "$cache_dir" ] && mkdir -p "$cache_dir" 

lock_file="${cache_dir}/.lock"

(

flock -e 3
cp $config_dir/* $html_root/
update_outdated
if [ "$read_report" == "yes" ]; then
    process_report
    update_host_cache
fi
update_index_cache
cp ${cache_dir}/*.html $html_root/

)3>$lock_file
