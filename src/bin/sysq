#!/bin/sh


usage="sysq [-hV] -f FIFO_PATH -w WEB_ROOT"
VERSION="0.0.1"

cache_dir="${HOME}/.cache/sysview"

while getopts hVf:w: flag; do
    case "$flag" in
        h) echo "$usage"; exit 0 ;;
        V) echo "$VERSION"; exit 0 ;;
        f) fifo_path="$OPTARG" ;;
        w) web_root="$OPTARG" ;;
        ?) echo "error: invalid arg" 1>&2; exit 1 ;;
    esac
done

[ -z "$web_root" ] && echo 1>&2 "error: missing argument" && exit 1
[ -z "$fifo_path" ] && echo 1>&2 "error: missing argument" && exit 1
[ -p "$fifo_path" ] || mkfifo $fifo_path || exit 1

while read line; do
    report="${report}${line}\n"
done

report_file="$(mktemp ${cache_dir}/fifo-report-XXXXXX)"
echo "$report" > $report_file
echo "U $report_file $web_root" > $fifo_path
